# CampusWorld æ•°æ®åº“Schemaå·¥å…· - ä¿®å¤ç‰ˆ

## ğŸ“‹ é—®é¢˜åˆ†æ

åŸå§‹æ•°æ®åº“schemaæ‰§è¡Œå¤±è´¥çš„ä¸»è¦åŸå› ï¼š

### 1. **SQLè¯­å¥åˆ†å‰²é—®é¢˜**
- ä½¿ç”¨ç®€å•çš„`;`åˆ†å‰²SQLè¯­å¥
- PostgreSQLå‡½æ•°å®šä¹‰åŒ…å«å¤šä¸ªåˆ†å·ï¼Œè¢«é”™è¯¯åˆ†å‰²
- å¯¼è‡´è¯­æ³•é”™è¯¯å’Œå‡½æ•°å®šä¹‰ä¸å®Œæ•´

### 2. **æ‰§è¡Œé¡ºåºé”™è¯¯**
- åœ¨åˆ›å»ºè¡¨ä¹‹å‰å°±å°è¯•æ·»åŠ å¤–é”®çº¦æŸ
- åœ¨åˆ›å»ºè¡¨ä¹‹å‰å°±å°è¯•åˆ›å»ºç´¢å¼•
- åœ¨åˆ›å»ºè¡¨ä¹‹å‰å°±å°è¯•åˆ›å»ºè§†å›¾

### 3. **äº‹åŠ¡å¤„ç†é—®é¢˜**
- ç¬¬ä¸€ä¸ªé”™è¯¯å¯¼è‡´äº‹åŠ¡å¤±è´¥
- åç»­æ‰€æœ‰æ“ä½œéƒ½è¢«å¿½ç•¥
- ç¼ºä¹é”™è¯¯æ¢å¤æœºåˆ¶

### 4. **æ–‡ä»¶è·¯å¾„é—®é¢˜**
- è¿ç§»è„šæœ¬åœ¨`db/schemas/`ç›®å½•ä¸‹
- SQLæ–‡ä»¶è·¯å¾„ä¸æ­£ç¡®
- ç›¸å¯¹è·¯å¾„å¼•ç”¨é—®é¢˜

## ğŸš€ ä¿®å¤æ–¹æ¡ˆ

### 1. **ä¿®å¤åçš„SQLæ–‡ä»¶** (`database_schema_fixed.sql`)
- **æ­£ç¡®çš„æ‰§è¡Œé¡ºåº**ï¼šè¡¨ â†’ çº¦æŸ â†’ ç´¢å¼• â†’ å‡½æ•° â†’ è§¦å‘å™¨ â†’ è§†å›¾ â†’ æ•°æ®
- **äº‹åŠ¡å®‰å…¨å¤„ç†**ï¼šä½¿ç”¨`IF NOT EXISTS`é¿å…é‡å¤åˆ›å»º
- **ä¾èµ–å…³ç³»ç®¡ç†**ï¼šç¡®ä¿æ‰€æœ‰ä¾èµ–é¡¹æŒ‰æ­£ç¡®é¡ºåºåˆ›å»º
- **å®Œæ•´çš„å‡½æ•°å®šä¹‰**ï¼šé¿å…å‡½æ•°å®šä¹‰è¢«é”™è¯¯åˆ†å‰²

### 2. **ä¿®å¤åçš„è¿ç§»è„šæœ¬** (`database_migration_fixed.py`)
- **æ™ºèƒ½SQLåˆ†å‰²**ï¼šè¯†åˆ«å‡½æ•°ã€è§¦å‘å™¨ã€è§†å›¾å®šä¹‰
- **é”™è¯¯æ¢å¤æœºåˆ¶**ï¼šæ£€æµ‹å…³é”®é”™è¯¯æ—¶å›æ»šäº‹åŠ¡
- **è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—**ï¼šæ˜¾ç¤ºæ¯ä¸ªSQLè¯­å¥çš„æ‰§è¡ŒçŠ¶æ€
- **å®Œæ•´çš„éªŒè¯æµç¨‹**ï¼šéªŒè¯è¡¨ã€è§†å›¾ã€å‡½æ•°æ˜¯å¦åˆ›å»ºæˆåŠŸ

### 3. **ç›´æ¥æ‰§è¡Œè„šæœ¬** (`run_schema_direct.py`)
- **ç®€åŒ–æ‰§è¡Œæµç¨‹**ï¼šç›´æ¥æ‰§è¡ŒSQLæ–‡ä»¶ï¼Œé¿å…å¤æ‚è¿ç§»é€»è¾‘
- **æ™ºèƒ½è¯­å¥åˆ†å‰²**ï¼šæ­£ç¡®å¤„ç†PostgreSQLè¯­æ³•ç»“æ„
- **å®æ—¶æ‰§è¡Œåé¦ˆ**ï¼šæ˜¾ç¤ºæ¯ä¸ªè¯­å¥çš„æ‰§è¡Œç»“æœ
- **è‡ªåŠ¨éªŒè¯ç»“æœ**ï¼šæ‰§è¡Œå®Œæˆåè‡ªåŠ¨éªŒè¯æ•°æ®åº“ç»“æ„

## ğŸ› ï¸ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1ï¼šä½¿ç”¨ç›´æ¥æ‰§è¡Œè„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# è¿›å…¥schemasç›®å½•
cd campusworld/backend/db/schemas

# æ‰§è¡Œä¿®å¤åçš„SQLæ–‡ä»¶
python run_schema_direct.py
```

### æ–¹æ³•2ï¼šä½¿ç”¨ä¿®å¤åçš„è¿ç§»è„šæœ¬

```bash
# è¿›å…¥schemasç›®å½•
cd campusworld/backend/db/schemas

# æ‰§è¡Œä¿®å¤åçš„è¿ç§»è„šæœ¬
python database_migration_fixed.py
```

### æ–¹æ³•3ï¼šç›´æ¥æ‰§è¡ŒSQLæ–‡ä»¶

```bash
# ä½¿ç”¨psqlç›´æ¥æ‰§è¡Œ
psql -h localhost -p 5433 -U campusworld_dev_user -d campusworld_dev -f database_schema_fixed.sql
```

## ğŸ“Š æ‰§è¡Œæµç¨‹

### ç¬¬ä¸€é˜¶æ®µï¼šåˆ›å»ºåŸºç¡€è¡¨ç»“æ„
1. `node_types` - èŠ‚ç‚¹ç±»å‹å®šä¹‰è¡¨
2. `relationship_types` - å…³ç³»ç±»å‹å®šä¹‰è¡¨
3. `nodes` - èŠ‚ç‚¹å®ä¾‹è¡¨ï¼ˆæ ¸å¿ƒè¡¨ï¼‰
4. `relationships` - å…³ç³»å®ä¾‹è¡¨
5. `node_attribute_indexes` - èŠ‚ç‚¹å±æ€§ç´¢å¼•è¡¨
6. `node_tag_indexes` - èŠ‚ç‚¹æ ‡ç­¾ç´¢å¼•è¡¨

### ç¬¬äºŒé˜¶æ®µï¼šæ·»åŠ å¤–é”®çº¦æŸ
- ç¡®ä¿è¡¨é—´å…³ç³»çš„å®Œæ•´æ€§
- æ”¯æŒçº§è”åˆ é™¤æ“ä½œ

### ç¬¬ä¸‰é˜¶æ®µï¼šåˆ›å»ºç´¢å¼•
- B-treeç´¢å¼•ï¼šä¸»é”®ã€å¤–é”®ã€å¸¸ç”¨æŸ¥è¯¢å­—æ®µ
- GINç´¢å¼•ï¼šJSONBå­—æ®µã€æ•°ç»„å­—æ®µ
- å¤åˆç´¢å¼•ï¼šå¤šå­—æ®µç»„åˆæŸ¥è¯¢ä¼˜åŒ–
- å…¨æ–‡æœç´¢ç´¢å¼•ï¼šæ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢

### ç¬¬å››é˜¶æ®µï¼šåˆ›å»ºå‡½æ•°
- `update_node_attribute_indexes()` - è‡ªåŠ¨ç»´æŠ¤å±æ€§ç´¢å¼•
- `update_node_tag_indexes()` - è‡ªåŠ¨ç»´æŠ¤æ ‡ç­¾ç´¢å¼•

### ç¬¬äº”é˜¶æ®µï¼šåˆ›å»ºè§¦å‘å™¨
- èŠ‚ç‚¹å±æ€§å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°ç´¢å¼•
- èŠ‚ç‚¹æ ‡ç­¾å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°ç´¢å¼•

### ç¬¬å…­é˜¶æ®µï¼šåˆ›å»ºè§†å›¾
- `active_nodes` - æ´»è·ƒèŠ‚ç‚¹è§†å›¾
- `active_relationships` - æ´»è·ƒå…³ç³»è§†å›¾

### ç¬¬ä¸ƒé˜¶æ®µï¼šæ’å…¥åˆå§‹æ•°æ®
- é¢„å®šä¹‰èŠ‚ç‚¹ç±»å‹ï¼ˆuser, campus, world, world_objectï¼‰
- é¢„å®šä¹‰å…³ç³»ç±»å‹ï¼ˆmember, friend, owns, locationï¼‰

### ç¬¬å…«é˜¶æ®µï¼šæ·»åŠ è¡¨æ³¨é‡Š
- ä¸ºæ‰€æœ‰è¡¨æ·»åŠ ä¸­æ–‡æ³¨é‡Š
- ä¾¿äºç†è§£å’Œç»´æŠ¤

## ğŸ” éªŒè¯æ­¥éª¤

æ‰§è¡Œå®Œæˆåï¼Œè„šæœ¬ä¼šè‡ªåŠ¨éªŒè¯ï¼š

### 1. **è¡¨ç»“æ„éªŒè¯**
```sql
-- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('node_types', 'relationship_types', 'nodes', 'relationships', 'node_attribute_indexes', 'node_tag_indexes');
```

### 2. **è§†å›¾éªŒè¯**
```sql
-- æ£€æŸ¥è§†å›¾æ˜¯å¦å­˜åœ¨
SELECT viewname FROM pg_views 
WHERE viewname IN ('active_nodes', 'active_relationships');
```

### 3. **å‡½æ•°éªŒè¯**
```sql
-- æ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨
SELECT routine_name FROM information_schema.routines 
WHERE routine_name IN ('update_node_attribute_indexes', 'update_node_tag_indexes');
```

### 4. **ç´¢å¼•éªŒè¯**
```sql
-- æ£€æŸ¥ç´¢å¼•æ˜¯å¦åˆ›å»º
SELECT indexname FROM pg_indexes 
WHERE tablename IN ('nodes', 'relationships');
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. **æ•°æ®åº“è¿æ¥**
- ç¡®ä¿PostgreSQLæœåŠ¡æ­£åœ¨è¿è¡Œ
- æ£€æŸ¥è¿æ¥å‚æ•°ï¼ˆä¸»æœºã€ç«¯å£ã€ç”¨æˆ·åã€å¯†ç ã€æ•°æ®åº“åï¼‰
- ç¡®ä¿ç”¨æˆ·æœ‰è¶³å¤Ÿçš„æƒé™åˆ›å»ºè¡¨ã€å‡½æ•°ã€è§¦å‘å™¨

### 2. **æ‰©å±•æ”¯æŒ**
- ç¡®ä¿`uuid-ossp`æ‰©å±•å¯ç”¨
- ç¡®ä¿`pg_trgm`æ‰©å±•å¯ç”¨ï¼ˆç”¨äºå…¨æ–‡æœç´¢ï¼‰

### 3. **äº‹åŠ¡å¤„ç†**
- è„šæœ¬ä½¿ç”¨è‡ªåŠ¨æäº¤æ¨¡å¼
- æ¯ä¸ªSQLè¯­å¥ç‹¬ç«‹æ‰§è¡Œ
- å¤±è´¥æ—¶ä¸ä¼šå½±å“å·²æˆåŠŸçš„æ“ä½œ

### 4. **é”™è¯¯å¤„ç†**
- å¿½ç•¥"å·²å­˜åœ¨"çš„é”™è¯¯
- è®°å½•å…¶ä»–é”™è¯¯çš„è¯¦ç»†ä¿¡æ¯
- æä¾›æ‰§è¡Œç»Ÿè®¡ä¿¡æ¯

## ğŸ› æ•…éšœæ’é™¤

### 1. **è¿æ¥å¤±è´¥**
```bash
# æ£€æŸ¥PostgreSQLæœåŠ¡çŠ¶æ€
docker ps | grep postgres

# æ£€æŸ¥ç«¯å£æ˜¯å¦å¼€æ”¾
netstat -an | grep 5433
```

### 2. **æƒé™ä¸è¶³**
```sql
-- æ£€æŸ¥ç”¨æˆ·æƒé™
SELECT usename, usesuper, usecreatedb FROM pg_user WHERE usename = 'campusworld_dev_user';

-- æˆäºˆå¿…è¦æƒé™
GRANT ALL PRIVILEGES ON DATABASE campusworld_dev TO campusworld_dev_user;
GRANT ALL PRIVILEGES ON SCHEMA public TO campusworld_dev_user;
```

### 3. **æ‰©å±•ä¸å¯ç”¨**
```sql
-- æ£€æŸ¥æ‰©å±•çŠ¶æ€
SELECT * FROM pg_extension WHERE extname IN ('uuid-ossp', 'pg_trgm');

-- å®‰è£…æ‰©å±•
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_trgm";
```

### 4. **è¡¨å·²å­˜åœ¨**
- è„šæœ¬ä¼šè‡ªåŠ¨è·³è¿‡å·²å­˜åœ¨çš„å¯¹è±¡
- å¦‚éœ€é‡æ–°åˆ›å»ºï¼Œå…ˆåˆ é™¤ç°æœ‰å¯¹è±¡ï¼š
```sql
DROP SCHEMA public CASCADE;
CREATE SCHEMA public;
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. **ç´¢å¼•ç­–ç•¥**
- ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºB-treeç´¢å¼•
- ä¸ºJSONBå­—æ®µåˆ›å»ºGINç´¢å¼•
- ä¸ºå…¨æ–‡æœç´¢åˆ›å»ºtrigramç´¢å¼•

### 2. **åˆ†åŒºç­–ç•¥**
- è€ƒè™‘æŒ‰æ—¶é—´æˆ–ç±»å‹å¯¹å¤§å‹è¡¨è¿›è¡Œåˆ†åŒº
- æé«˜æŸ¥è¯¢å’Œç»´æŠ¤æ€§èƒ½

### 3. **ç»Ÿè®¡ä¿¡æ¯**
- å®šæœŸæ›´æ–°è¡¨ç»Ÿè®¡ä¿¡æ¯
- ä¼˜åŒ–æŸ¥è¯¢è®¡åˆ’

## ğŸ”„ åç»­ç»´æŠ¤

### 1. **å®šæœŸå¤‡ä»½**
```bash
pg_dump -h localhost -p 5433 -U campusworld_dev_user -d campusworld_dev > backup_$(date +%Y%m%d).sql
```

### 2. **æ€§èƒ½ç›‘æ§**
```sql
-- æ£€æŸ¥æ…¢æŸ¥è¯¢
SELECT query, mean_time, calls FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 10;

-- æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT schemaname, tablename, indexname, idx_scan, idx_tup_read, idx_tup_fetch 
FROM pg_stat_user_indexes ORDER BY idx_scan DESC;
```

### 3. **æ•°æ®æ¸…ç†**
```sql
-- æ¸…ç†æ— æ•ˆæ•°æ®
DELETE FROM nodes WHERE is_active = FALSE AND updated_at < CURRENT_TIMESTAMP - INTERVAL '30 days';
DELETE FROM relationships WHERE is_active = FALSE AND updated_at < CURRENT_TIMESTAMP - INTERVAL '30 days';
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æ£€æŸ¥é”™è¯¯æ—¥å¿—å’Œè¾“å‡ºä¿¡æ¯
2. éªŒè¯æ•°æ®åº“è¿æ¥å’Œæƒé™
3. ç¡®è®¤PostgreSQLç‰ˆæœ¬å’Œæ‰©å±•æ”¯æŒ
4. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„æ•…éšœæ’é™¤éƒ¨åˆ†

---

**ä½œè€…**: AI Assistant  
**åˆ›å»ºæ—¶é—´**: 2025-08-24  
**ç‰ˆæœ¬**: ä¿®å¤ç‰ˆ v1.0
